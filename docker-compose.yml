# Usage
#   Start:          docker compose up
#   With helpers:   docker compose -f docker-compose.yml -f ./.devcontainer/docker-compose.dev.yml up
#   Stop:           docker compose down
#   Destroy:        docker compose -f docker-compose.yml -f ./.devcontainer/docker-compose.dev.yml down -v --remove-orphans

version: '3'
name: glados-project

# Make sure you have a .env file in the root of the project, it supplies variables in the ${}

services:
  app-backend:
    build:
      context: ./apps/backend
      dockerfile: ./backend.Dockerfile
      target: production
    container_name: glados-backend
    environment:
      FIREBASE_KEY: ${FIREBASE_KEY}
      BACKEND_PORT: ${BACKEND_PORT}
    volumes:
        - ./apps/backend/ExperimentFiles:/app/ExperimentFiles
    ports:
        # TODO does this need to be exposed to host?
        - ${BACKEND_PORT}:${BACKEND_PORT}
    expose:
        - "${BACKEND_PORT}"

  app-frontend:
    build:
      context: ./apps/frontend
      dockerfile: ./frontend.Dockerfile
    container_name: glados-frontend
    working_dir: /home/node/app
    # TODO switch to ${FRONTEND_WEBSERVER_PORT}
    ports:
      - 3000:3000
      - 80:3000
    expose:
      - "3000"
      - "80"
  app-mongodb:
    image: mongo
    container_name: glados-mongodb
    ports:
      - 27017:27017
    expose:
      - "27017"
    volumes:
      - ./data/db:/data/db
networks:
  default:
    driver: bridge
    name: glados-bridge

    # Enable this when/if we switch to Docker Swarm
    # driver: overlay
    # attachable: true
    # name: glados-overlay
