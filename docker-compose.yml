# Usage
#   Start:          docker-compose up
#   With helpers:   docker-compose -f docker-compose.yml -f ./dev/docker-compose.dev.yml up
#   Stop:           docker-compose down
#   Destroy:        docker-compose -f docker-compose.yml -f ./dev/docker-compose.dev.yml down -v --remove-orphans

version: '3'
name: glados-project

services:
  # TODO move the devcontainer to its own compose file so it doesn't start with production stuff
  app-devcontainer:
    build:
      context: ./.devcontainer
      dockerfile: ./devcontainer.Dockerfile
    container_name: glados-devcontainer
    volumes:
      # Forwards the local Docker socket to the container.
      - /var/run/docker.sock:/var/run/docker-host.sock 
      # Update this to wherever you want VS Code to mount the folder of your project
      - .:/workspaces/Monorepo:cached

    # Overrides default command so things don't shut down after the process ends.
    entrypoint: /usr/local/share/docker-init.sh
    command: sleep infinity

  app-backend:
    build:
      context: ./apps/backend
      dockerfile: ./backend.Dockerfile
    container_name: glados-backend
    environment:
      creds: ${FIREBASE_KEY}
    volumes:
        - ./apps/backend/ExperimentFiles:/app/ExperimentFiles
    # TODO switch to ${BACKEND_PORT}
    ports:
        # TODO does this need to be exposed to host?
        - 5050:5050
    expose:
        - "5050"

  app-frontend:
    build:
      context: ./apps/frontend
      dockerfile: ./frontend.Dockerfile
    container_name: glados-frontend
    volumes:
      - ./apps/frontend:/home/node/app
    working_dir: /home/node/app
    # TODO switch to ${FRONTEND_WEBSERVER_PORT}
    ports:
      - 3000:3000
    expose:
      - "3000"
